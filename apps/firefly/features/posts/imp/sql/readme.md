# Posts SQL Schema

*Database schema for Firefly posts with semantic search*

## Overview

The `posts` table stores user-created content with support for:
- Hierarchical post organization (parent-child relationships)
- Vector embeddings for semantic search
- Rich metadata (timezone, location, AI-generated flag)
- Fast similarity search using HNSW indexing

## Table Structure

```sql
posts (
    id              SERIAL PRIMARY KEY,
    user_id         INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    parent_id       INTEGER REFERENCES posts(id) ON DELETE CASCADE,
    title           TEXT NOT NULL,
    summary         TEXT NOT NULL,
    body            TEXT NOT NULL,
    image_url       TEXT,
    created_at      TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    timezone        VARCHAR(50) NOT NULL,
    location_tag    TEXT,
    ai_generated    BOOLEAN NOT NULL DEFAULT FALSE,
    embedding       vector(768)
)
```

## Fields

### id
- Type: `SERIAL PRIMARY KEY`
- Auto-incrementing unique identifier for each post

### user_id
- Type: `INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE`
- ID of the user who created this post
- Foreign key to users table
- CASCADE delete: when user is deleted, all their posts are deleted

### parent_id
- Type: `INTEGER REFERENCES posts(id) ON DELETE CASCADE`
- ID of parent post (NULL for root/top-level posts)
- Enables tree structure: posts can be organized hierarchically
- CASCADE delete: when parent is deleted, all children are deleted
- Self-referencing foreign key

### title
- Type: `TEXT NOT NULL`
- Post title/heading
- Required field

### summary
- Type: `TEXT NOT NULL`
- One-line summary of the post
- Displayed in feeds and search results
- Required field

### body
- Type: `TEXT NOT NULL`
- Main post content (markdown format)
- Typically 300 words or less
- Required field

### image_url
- Type: `TEXT` (nullable)
- URL to optional post image
- NULL if no image attached

### created_at
- Type: `TIMESTAMP WITH TIME ZONE`
- Post creation timestamp in UTC
- Automatically set on insert
- Used for chronological ordering

### timezone
- Type: `VARCHAR(50) NOT NULL`
- User's timezone when post was created
- Format: IANA timezone (e.g., "America/New_York", "Europe/London")
- Allows displaying local time to users

### location_tag
- Type: `TEXT` (nullable)
- Optional location tag
- Free-form text (e.g., "San Francisco, CA" or "Central Park")

### ai_generated
- Type: `BOOLEAN NOT NULL DEFAULT FALSE`
- Whether this post was generated by AI
- Important for transparency: users should know if content is AI-generated
- Default: false (human-created)

### embedding
- Type: `vector(768)` (pgvector extension)
- 768-dimensional vector embedding of post content
- Generated using sentence-transformers
- Used for semantic similarity search
- NULL allowed (can be computed asynchronously)

## Indexes

```sql
-- User lookup: find all posts by a user
CREATE INDEX idx_posts_user_id ON posts(user_id);

-- Tree navigation: find children of a post
CREATE INDEX idx_posts_parent_id ON posts(parent_id);

-- Chronological ordering: recent posts
CREATE INDEX idx_posts_created_at ON posts(created_at DESC);

-- Vector similarity search (HNSW algorithm)
CREATE INDEX idx_posts_embedding ON posts
USING hnsw (embedding vector_cosine_ops);
```

### HNSW Index Explanation
- **HNSW** = Hierarchical Navigable Small World
- Fast approximate nearest neighbor search
- `vector_cosine_ops`: uses cosine similarity
- Much faster than exhaustive search for large datasets

## Common Queries

### Create a post

```sql
INSERT INTO posts (user_id, title, summary, body, timezone, embedding)
VALUES (
    123,
    'My First Post',
    'A brief summary of my thoughts',
    'The full body text goes here with more details...',
    'America/Los_Angeles',
    '[0.1, 0.2, 0.3, ...]'::vector  -- 768-dimensional array
)
RETURNING id;
```

### Get post by ID

```sql
SELECT id, user_id, parent_id, title, summary, body, image_url,
       created_at, timezone, location_tag, ai_generated
FROM posts
WHERE id = 456;
```

Note: We typically don't select `embedding` in queries (it's large).

### Get all posts by user

```sql
SELECT id, title, summary, created_at, ai_generated
FROM posts
WHERE user_id = 123
ORDER BY created_at DESC
LIMIT 50;
```

### Get child posts (replies/comments)

```sql
SELECT id, user_id, title, summary, created_at
FROM posts
WHERE parent_id = 456
ORDER BY created_at ASC;
```

### Get recent posts (global feed)

```sql
SELECT p.id, p.title, p.summary, p.created_at, p.ai_generated,
       u.email as author_email
FROM posts p
JOIN users u ON p.user_id = u.id
WHERE p.parent_id IS NULL  -- Only root posts
ORDER BY p.created_at DESC
LIMIT 50;
```

### Semantic search using vector similarity

```sql
SELECT
    id, user_id, title, summary, created_at, ai_generated,
    1 - (embedding <=> '[0.1, 0.2, ...]'::vector) as similarity
FROM posts
WHERE embedding IS NOT NULL
AND 1 - (embedding <=> '[0.1, 0.2, ...]'::vector) >= 0.7  -- 70% similarity threshold
ORDER BY embedding <=> '[0.1, 0.2, ...]'::vector
LIMIT 10;
```

**Operator**: `<=>` is the cosine distance operator from pgvector
- Distance = 1 - similarity
- Lower distance = more similar
- Threshold 0.7 = 70% similarity

### Get post tree (post with all descendants)

```sql
WITH RECURSIVE post_tree AS (
    -- Base case: the root post
    SELECT id, parent_id, title, summary, 0 as depth
    FROM posts
    WHERE id = 456

    UNION ALL

    -- Recursive case: children
    SELECT p.id, p.parent_id, p.title, p.summary, pt.depth + 1
    FROM posts p
    JOIN post_tree pt ON p.parent_id = pt.id
)
SELECT * FROM post_tree
ORDER BY depth, id;
```

### Count posts by user

```sql
SELECT user_id, COUNT(*) as post_count
FROM posts
GROUP BY user_id
ORDER BY post_count DESC;
```

### Find posts without embeddings (need processing)

```sql
SELECT id, title
FROM posts
WHERE embedding IS NULL
ORDER BY created_at DESC;
```

## Design Decisions

### Why hierarchical structure?
- Enables threaded discussions
- Posts can be organized into topic trees
- Allows grouping related content
- Future feature: summarizing a thread into a parent post

### Why 768-dimensional embeddings?
- Standard output size for sentence-transformers models
- Good balance of quality vs. size
- Compatible with popular embedding models:
  - `all-mpnet-base-v2` (768 dims)
  - `all-MiniLM-L6-v2` (384 dims - can also use)

### Why pgvector + HNSW?
- Fast approximate nearest neighbor search
- Scales to millions of posts
- Better than exhaustive search (checking every post)
- Good accuracy/speed tradeoff

### Why ai_generated flag?
- Transparency: users should know if content is AI-generated
- Future feature: auto-summarization of human posts
- Important for trust and authenticity

### Why store timezone separately?
- Display local time to users ("posted 2 hours ago")
- created_at is always UTC for consistency
- timezone field allows converting back to local time

## Vector Operations

### Distance operators (pgvector)

```sql
-- Cosine distance (recommended for normalized vectors)
embedding <=> query_vector

-- L2 distance (Euclidean)
embedding <-> query_vector

-- Inner product
embedding <#> query_vector
```

For semantic search, cosine distance is typically best.

### Similarity to distance conversion

```
similarity = 1 - cosine_distance
```

Example:
- Distance 0.0 = 100% similar (identical)
- Distance 0.3 = 70% similar
- Distance 1.0 = 0% similar (opposite)

## Relationships

```
users (1) ─────< (*) posts
                  │
                  └─< posts (self-referencing: parent-child)
```

A post belongs to one user, and can have one parent post.

## Migration Notes

### Adding this table to existing database

**Prerequisites**: `users` table must exist first.

```sql
-- Ensure pgvector extension is installed
CREATE EXTENSION IF NOT EXISTS vector;

-- Run schema
\i posts/imp/sql/schema.sql

-- Grant permissions
GRANT ALL PRIVILEGES ON TABLE posts TO firefly_user;
GRANT ALL PRIVILEGES ON SEQUENCE posts_id_seq TO firefly_user;
```

### Dropping and recreating

```sql
-- WARNING: Destroys all post data
DROP TABLE IF EXISTS posts CASCADE;

-- Recreate
\i posts/imp/sql/schema.sql
```

## Performance Considerations

### Index usage

```sql
-- Check if indexes are being used
EXPLAIN ANALYZE
SELECT * FROM posts WHERE user_id = 123;
```

Should show "Index Scan using idx_posts_user_id".

### Vector index build time

HNSW index builds can be slow for large datasets:
- Small dataset (<10k posts): builds quickly
- Large dataset (>100k posts): may take minutes
- Consider building index after bulk imports

### Embedding storage

Each 768-dimensional vector takes ~3KB of space:
- 1,000 posts = ~3 MB
- 100,000 posts = ~300 MB
- 1,000,000 posts = ~3 GB

## Future Enhancements

Potential schema additions:

```sql
-- Reactions/likes
ALTER TABLE posts ADD COLUMN like_count INTEGER DEFAULT 0;

-- View count
ALTER TABLE posts ADD COLUMN view_count INTEGER DEFAULT 0;

-- Edit history
ALTER TABLE posts ADD COLUMN edited_at TIMESTAMP WITH TIME ZONE;

-- Visibility
ALTER TABLE posts ADD COLUMN visibility VARCHAR(20) DEFAULT 'public';
-- Options: 'public', 'private', 'unlisted'

-- Tags
ALTER TABLE posts ADD COLUMN tags TEXT[];
CREATE INDEX idx_posts_tags ON posts USING GIN(tags);
```
